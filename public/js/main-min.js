import*as THREE from"../three.js-r112/build/three.module.js";import{StereoEffect}from"../three.js-r112/examples/jsm/effects/StereoEffect.js";import{FirstPersonControls}from"../three.js-r112/examples/jsm/controls/FirstPersonControls.js";import{DeviceOrientationControls}from"../three.js-r112/examples/jsm/controls/DeviceOrientationControls.js";import Grave from"./_grave.js";import Stats from"./libs/Stats.js";window.md=new MobileDetect(window.navigator.userAgent),window.shuffled=[],window.shuffledIndex=780,window.imgFolder="https://api.autr.tv/uploads/_/originals/ddd/";const getUrlVars=()=>{var e={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,(function(o,t,n){e[t]=n}));return e};for(window.addEventListener("gamepadconnected",e=>{console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",e.gamepad.index,e.gamepad.id,e.gamepad.buttons.length,e.gamepad.axes.length),e.gamepad.buttons.forEach(e=>{console.log("button",e)}),e.gamepad.axes.forEach(e=>{console.log("axis",e)})});shuffled.length<websites.length;){var randIndex=parseInt(Math.random()*websites.length,10);-1===shuffled.indexOf(randIndex)&&shuffled.push(randIndex)}function degToRadian(e){return e*(Math.PI/180)}const params=getUrlVars();let VR=!1;var scene,camera,renderer,light,gui,clock,spotlightGui,lightHelper,torch,source,dest,floor,sampler,solution,godCamera,godControls,controls,graves,models,areaSize,manager,sprite,w,h,stereoEffect,projector,INTERSECTED,vector,ray,mouse={x:0,y:0},shadow=1,blockColour=10066329,floorColour=11184810,ambientColour=11184810;function guiChange(){scene.fog.density=gui.fogDensity,godCamera.left=gui.l,godCamera.right=gui.r,godCamera.top=gui.t,godCamera.bottom=gui.b,godCamera.position.x=gui.x,godCamera.position.y=gui.y,godCamera.position.z=gui.z,godCamera.lookAt(scene.position),godCamera.updateProjectionMatrix()}function de2ra(e){return e*(Math.PI/180)}function spotlightChange(){light.intensity=spotlightGui.intensity,light.distance=spotlightGui.distance,light.angle=spotlightGui.angle,light.penumbra=spotlightGui.penumbra,light.decay=spotlightGui.decay,light.position.x=spotlightGui.x,light.position.y=spotlightGui.y,light.position.z=spotlightGui.z}window.message;var mouseDown=0;document.body.onmousedown=function(){++mouseDown},document.body.onmouseup=function(){--mouseDown};const onKeyDown=function(e){switch(controlsInited||$("#ctrlU").trigger("click"),e.keyCode){case 38:case 87:startEvent("actionForward");break;case 37:case 65:startEvent("actionLeft");break;case 40:case 83:startEvent("actionBackward");break;case 39:case 68:startEvent("actionRight");break;case 81:startEvent("actionUp");break;case 69:startEvent("actionDown")}},onKeyUp=function(e){switch(e.keyCode){case 38:case 87:stopEvent("actionForward");break;case 37:case 65:stopEvent("actionLeft");break;case 40:case 83:stopEvent("actionBackward");break;case 39:case 68:stopEvent("actionRight");break;case 81:stopEvent("actionUp");break;case 69:stopEvent("actionDown")}},startEvent=e=>{const o=$(`button[data-action='${e}']`)[0];o&&o.classList.add("active"),controlsInited&&("actionForward"===e&&(controls.moveForward=!0),"actionLeft"===e&&(controls.moveLeft=!0),"actionRight"===e&&(controls.moveRight=!0),"actionBackward"===e&&(controls.moveBackward=!0),"actionUp"===e&&(controls.moveUp=!0),"actionDown"===e&&(controls.moveDown=!0))},stopEvent=e=>{const o=$(`button[data-action='${e}']`)[0];o&&o.classList.remove("active"),controlsInited&&("actionForward"===e&&(controls.moveForward=!1),"actionLeft"===e&&(controls.moveLeft=!1),"actionRight"===e&&(controls.moveRight=!1),"actionBackward"===e&&(controls.moveBackward=!1),"actionUp"===e&&(controls.moveUp=!1),"actionDown"===e&&(controls.moveDown=!1))};let info=!1;window.onload=function(){window.message=$("#message")[0],init(),$(window).on("resize orientationchange",(function(e){w=window.innerWidth,h=window.innerHeight;renderer.setSize(w-20,h-20),stereoEffect.setSize(w,h),camera.aspect=w/h,camera.updateProjectionMatrix(),$("canvas").css({width:w-20,height:h-20}),$("#main").css({width:w,height:h})})),$(window).trigger("resize"),window.addEventListener("keydown",onKeyDown,!1),window.addEventListener("keyup",onKeyUp,!1);const e=()=>{VR||$("body").addClass("vr"),VR&&$("body").removeClass("vr"),setTimeout(()=>{VR=!VR,$(window).trigger("resize")},VR?0:400)};params&&params.mode&&"vr"===params.mode.toLowerCase()&&e(),$("button").click(o=>{"ctrlVR"===o.currentTarget.id&&e(),"ctrlInfo"===o.currentTarget.id&&(info||$("body").addClass("info"),info&&$("body").removeClass("info"),info=!info),controlsInited||(isMobile()?controls=new DeviceOrientationControls(camera,renderer.domElement):((controls=new FirstPersonControls(camera,renderer.domElement)).activeLook=!0,controls.autoForward=!1,controls.lookVertical=!0,controls.lookHorizontal=!0,controls.constrainVertical=!0,controls.verticalMin=.8,controls.verticalMax=2.2,controls.lookSpeed=.1),controls.movementSpeed=8,controlsInited=!0)}),$("button").bind("mousedown mouseenter",(e,o)=>{if("mouseenter"===e.type&&0===mouseDown)return;const t=e.currentTarget.getAttribute("data-action");startEvent(t)}).bind("mouseleave mouseup",(e,o)=>{if("mouseleave"===e.type&&0===mouseDown)return;const t=e.currentTarget.getAttribute("data-action");stopEvent(t)});const o=document.querySelectorAll("button");$(document).bind("touchstart touchmove touchend",(e,t)=>{VR&&("touchstart"===e.type&&(controls.moveForward=!0),"touchend"===e.type&&(controls.moveForward=!1)),o.forEach((o,t)=>{const n=((e,o)=>{const t=o.getBoundingClientRect();return e.pageX>=t.x&&e.pageX<=t.x+t.width&&e.pageY>=t.y&&e.pageY<=t.y+t.height})(e.originalEvent,o),a=$(o).hasClass("active"),i=o.getAttribute("data-action");!n&&a&&stopEvent(i),n&&!a&&startEvent(i),n&&a&&"touchend"===e.type&&stopEvent(i)})})};const isMobile=()=>void 0!==window.DeviceOrientationEvent&&"function"==typeof window.DeviceOrientationEvent.requestPermission,isVR=()=>VR,showStats=!1;function init(){showStats&&(window.stats=new Stats,window.stats.showPanel(1),document.body.appendChild(window.stats.dom)),w=window.innerWidth-20,h=window.innerHeight-20,areaSize=200,manager=new THREE.LoadingManager,clock=new THREE.Clock,gui={fogDensity:.02,l:4*areaSize/-2,r:4*areaSize/2,t:4*areaSize/2,b:4*areaSize/-2,x:0,y:8,z:8},spotlightGui={intensity:3,distance:200,angle:1,penumbra:1,decay:0,x:0,y:0,z:0};var e=new dat.GUI;e.add(gui,"fogDensity",0,.1).onChange(guiChange),e.add(gui,"l").onChange(guiChange),e.add(gui,"r").onChange(guiChange),e.add(gui,"t").onChange(guiChange),e.add(gui,"b").onChange(guiChange),e.add(gui,"x",-100,100).onChange(guiChange),e.add(gui,"y",-100,100).onChange(guiChange),e.add(gui,"z",-100,100).onChange(guiChange),e.add(spotlightGui,"intensity",0,3).onChange(spotlightChange),e.add(spotlightGui,"distance",0,200).onChange(spotlightChange),e.add(spotlightGui,"angle",0,10).onChange(spotlightChange),e.add(spotlightGui,"penumbra",0,1).onChange(spotlightChange),e.add(spotlightGui,"decay",0,2).onChange(spotlightChange),e.add(spotlightGui,"x",-100,100).onChange(spotlightChange),e.add(spotlightGui,"z",-100,100).onChange(spotlightChange),e.add(spotlightGui,"y",-100,100).onChange(spotlightChange),e.close(),dat.GUI.toggleHide(),(scene=new THREE.Scene).fog=new THREE.FogExp2(16777215,gui.fogDensity);var o=$("canvas.3d");(renderer=new THREE.WebGLRenderer({antialias:!0,canvas:o[0]})).setSize(w,h),shadow&&(renderer.shadowMap.enabled=!0),shadow&&(renderer.shadowMap.type=THREE.PCFSoftShadowMap),renderer.gammaInput=!0,renderer.gammaOutput=!0,renderer.xr.enabled=!0,stereoEffect=new StereoEffect(renderer),renderer.setClearColor(new THREE.Color(255,255,255),1),light=new THREE.SpotLight(16777215),shadow&&(light.castShadow=!0),light.position.set(spotlightGui.x,spotlightGui.y,spotlightGui.z),light.shadow.mapSize.width=1024,light.shadow.mapSize.height=1024,light.position.x=0,light.position.y=0,light.position.z=0;var t=new THREE.AmbientLight(ambientColour);scene.add(t),sampler=new PoissonDiskSampler(areaSize-10,areaSize-10,20,30),solution=sampler.sampleUntilSolution(),graves=[],models=[];var n=0;!function e(){var o=solution[n].x-areaSize/2,t=solution[n].y-areaSize/2,a=new Grave;a.init(o,t,scene).then(()=>{graves.push(a),models.push(a.model),n+=1,$(".loading").text("loading initial "+n+"/"+solution.length),n<solution.length&&e()}).catch(e=>{console.error("error",e)})}();new THREE.PlaneGeometry(50,50,8,8).faces.forEach((e,o)=>{(o+Math.floor(o/16)%2*2)%4<2&&e.color.setRGB(0,1,1)});new THREE.MeshBasicMaterial({color:16777215,vertexColors:THREE.FaceColors});(floor=new THREE.Mesh(new THREE.BoxGeometry(2*areaSize,2*areaSize,1,1),new THREE.MeshPhongMaterial({color:floorColour}))).material.side=THREE.DoubleSide,floor.rotation.x=de2ra(90),floor.position.y=0,shadow&&(floor.receiveShadow=!0),scene.add(floor),(source=new THREE.Mesh(new THREE.BoxGeometry(2,2,2),new THREE.MeshPhongMaterial({color:65535}))).position.x=0,source.position.y=20,source.position.z=20,camera=new THREE.PerspectiveCamera(60,w/h,.1,2e4),scene.add(camera),camera.add(source),source.add(light),light.target=camera,camera.position.y=6;var a=new THREE.Vector3(10,camera.position.y,0);camera.lookAt(a),renderer.domElement.addEventListener("mousemove",onDocumentMouseMove,!1),renderer.domElement.addEventListener("mousedown",onDocumentMouseDown,!1),document.addEventListener("keydown",e=>{},!1),(a=new THREE.Vector3(mouse.x,mouse.y,1)).unproject(camera),ray=new THREE.Raycaster(camera.position,a.sub(camera.position).normalize()),renderer.setAnimationLoop(animate)}let controlsInited=!1;const buttonPressed=e=>!0,gamepadLoop=()=>{var e=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[];if(e){var o=e[0];o&&(o.buttons[0],console.log("b 0"),o.buttons[1],console.log("b 1"),o.buttons[2],console.log("b 2"),o.buttons[3],console.log("b 3"))}};function animate(){gamepadLoop(),TWEEN.update(),showStats&&window.stats.begin();for(var e=0;e<graves.length-1;e++){var o=graves[e],t=o.model,n=t.position.z,a=camera.position.z,i=t.position.x,r=camera.position.x,s=!1;n-a>areaSize/2&&(t.position.z-=areaSize,s=!0),n-a<areaSize/2*-1&&(t.position.z+=areaSize,s=!0),i-r>areaSize/2&&(t.position.x-=areaSize,s=!0),i-r<areaSize/2*-1&&(t.position.x+=areaSize,s=!0),s&&o.texturise()}floor.position.x=camera.position.x,floor.position.z=camera.position.z,controlsInited&&controls.update(clock.getDelta()),camera.updateProjectionMatrix();camera.position.y<1&&(camera.position.y=1),VR||renderer.render(scene,camera),VR&&stereoEffect.render(scene,camera),showStats&&window.stats.end()}function onDocumentMouseMove(e){}var closeup=!1;function onDocumentMouseDown(e){}String.prototype.splice=function(e,o,t){return this.slice(0,e)+t+this.slice(e+Math.abs(o))};